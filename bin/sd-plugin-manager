#!/usr/bin/env php
<?php

use sd\SwPluginManager\DependencyInjection\PluginProviderPass;
use Symfony\Component\Config\FileLocator;
use Symfony\Component\Console\Application;
use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\DependencyInjection\Loader\YamlFileLoader;

require_once __DIR__ . '/../vendor/autoload.php';

// Create container and register compiler pass
$containerBuilder = new ContainerBuilder();
$containerBuilder->addCompilerPass(new PluginProviderPass());

// Load services
$yamlConfigLoader = new YamlFileLoader($containerBuilder, new FileLocator(__DIR__ . '/../src'));
$yamlConfigLoader->load('Resources/config/services.yml');

$containerBuilder->compile();

// Initilize CLI apllication
$application = new Application();
$commandsClassBase = 'sd\\SwPluginManager\\Command\\';

// iterate through commands
$fileIterator = new DirectoryIterator(__DIR__ . '/../src/Command');
foreach ($fileIterator as $file) {
    if (false === $file->isFile()) {
        continue;
    }

    try {
        $commandName = $commandsClassBase . $file->getBasename('.' . $file->getExtension());
        $application->add(new $commandName());
    } catch (RuntimeException $exception) {
        echo 'Could not load command "' . $commandName . '". Is there a class in src/ that does not belong there?' .
            PHP_EOL;
    }
}

$application->run();
